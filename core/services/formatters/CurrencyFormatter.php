<?php

namespace EventEspresso\core\services\formatters;

use EE_Currency_Config;
use EventEspresso\core\services\locale\Locale;
use EventEspresso\core\services\locale\Locales;

class CurrencyFormatter extends LocaleFloatFormatter
{

    /**
     * non-localized number no symbol or code: '123456.123456'
     */
    const FORMAT_PRECISION_FLOAT = 0;

    /**
     * localized number no symbol or code: '123,456.12'
     */
    const FORMAT_LOCALIZED_FLOAT = 1;

    /**
     * localized number with currency symbol: '$123,456.12'
     */
    const FORMAT_LOCALIZED_CURRENCY = 2;

    /**
     * localized number with currency symbol and code: '$123,456.12 USD'
     */
    const FORMAT_LOCALIZED_CURRENCY_RAW_CODE = 3;

    /**
     * localized number with currency symbol and code wrapped in span: '$123,456.12 <span>USD</span>'
     */
    const FORMAT_LOCALIZED_CURRENCY_HTML_CODE = 4;

    /**
     * @var EE_Currency_Config
     */
    protected $currency_config;


    /**
     * LocaleFloatFormatter constructor.
     *
     * @param EE_Currency_Config $currency_config
     * @param Locales            $locales
     */
    public function __construct(EE_Currency_Config $currency_config, Locales $locales)
    {
        $this->currency_config = $currency_config;
        parent::__construct($locales);
    }


    /**
     * formats the provided amount for the selected locale (defaults to site locale) and returns a string
     *
     * @param Locale   $locale
     * @param float    $amount    unformatted number value, ex: 1234.56789
     * @param int      $format    one of the CurrencyFormatter::FORMAT_* constants
     * @param int|null $precision the number of decimal places to round to
     * @return string             formatted amount, ex: '1,234.57'
     */
    protected function format(
        Locale $locale,
        float $amount,
        int $format = CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY,
        ?int $precision = null
    ): string {
        // if a specific decimal precision has been requested then use that, otherwise set it for the locale
        $precision = $precision !== null ? absint($precision) : $locale->decimalPrecision();
        // BUT... if a specific decimal precision has been requested with no extra locale formatting
        // then bump the precision up to our max internal value
        $precision = $format === CurrencyFormatter::FORMAT_PRECISION_FLOAT && $precision === $locale->decimalPrecision()
            ? LocaleFloatFormatter::DECIMAL_PRECISION
            : $precision;

        // if only a float is requested then just return now
        if ($format < CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY) {
            return $format === CurrencyFormatter::FORMAT_PRECISION_FLOAT
                ? $this->precisionRound($amount)
                : $this->roundForLocale($amount);
        }
        // inserts symbols for the locale's decimal and thousands separator at the appropriate places
        $formatted_amount = $this->formatGroupings(
            $amount,
            absint($precision),
            $locale->currencyDecimalPoint(),
            $locale->currencyGrouping(),
            $locale->currencyThousandsSeparator()
        );

        // inserts the locale's currency symbol, negative sign, and spaces at the appropriate places
        $formatted_amount = $this->formatSymbolAndSignPositions(
            $locale,
            $formatted_amount,
            $amount < 0, // negative
            $locale->currencySymbol()
        );
        return $this->appendCurrencyIsoCode($locale, $formatted_amount, $format);
    }


    /**
     * @param Locale $locale
     * @param string $amount
     * @param int    $format one of the CurrencyFormatter::FORMAT_* constants
     * @return string        fully formatted amount with ISO code, ex: '$ 1,234.57 USD'
     */
    protected function appendCurrencyIsoCode(Locale $locale, string $amount, int $format): string
    {
        switch ($format) {
            case CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY_RAW_CODE:
                $iso_code = "&nbsp;{$locale->currencyIsoCode()}";
                break;
            case CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY_HTML_CODE:
                $iso_code = "&nbsp;<span class=\"currency-code\">({$locale->currencyIsoCode()})</span>";
                break;
            default:
                $iso_code = '';
        }
        // filter to allow global setting of display_code
        $display_code = apply_filters(
            'FHEE__EEH_Template__format_currency__display_code',
            $format > CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY
        );
        $iso_code     = $display_code
            ? $iso_code
            : '';
        return "{$amount}{$iso_code}";
    }


    /**
     * inserts the locale's currency symbol, negative sign, and spaces at the appropriate places
     *
     * @param Locale $locale
     * @param string $number
     * @param bool   $is_negative
     * @param string $currency_symbol
     * @return string partially formatted amount, ex: '$ 1,234.57'
     */
    protected function formatSymbolAndSignPositions(
        Locale $locale,
        string $number,
        bool $is_negative,
        string $currency_symbol
    ): string {
        // format for positive or negative values
        if ($is_negative) {
            $add_spacer  = $locale->currencySymbolSpaceB4Negative();
            $currency_b4 = $locale->currencySymbolB4Negative();
            $position    = $locale->negativeSignPosition();
            $sign        = $locale->negativeSign();
        } else {
            $add_spacer  = $locale->currencySymbolSpaceB4Positive();
            $currency_b4 = $locale->currencySymbolB4Positive();
            $position    = $locale->positiveSignPosition();
            $sign        = $locale->positiveSign();
        }
        $spacer = $add_spacer
            ? '&nbsp;'
            : '';
        switch ($position) {
            case LocaleFloatFormatter::PARENTHESES:
                return $currency_b4
                    ? "({$currency_symbol}{$spacer}{$number})"
                    : "({$number}{$spacer}{$currency_symbol})";
            case LocaleFloatFormatter::SIGN_BEFORE_ALL:
                return $currency_b4
                    ? "{$sign}{$currency_symbol}{$spacer}{$number}"
                    : "{$sign}{$number}{$spacer}{$currency_symbol}";
            case LocaleFloatFormatter::SIGN_AFTER_ALL:
                return $currency_b4
                    ? "{$currency_symbol}{$spacer}{$number} {$sign}"
                    : "{$number}{$spacer}{$currency_symbol} {$sign}";
            case LocaleFloatFormatter::SIGN_BEFORE_CURRENCY:
                return $currency_b4
                    ? "{$sign}{$currency_symbol}{$spacer}{$number}"
                    : "{$number}{$spacer}{$sign}{$currency_symbol}";
            case LocaleFloatFormatter::SIGN_AFTER_CURRENCY:
                return $currency_b4
                    ? "{$currency_symbol}{$sign}{$spacer}{$number}"
                    : "{$number}{$spacer}{$currency_symbol}{$sign}";
        }
        return $number;
    }


    /**
     * formats the provided number for the selected locale (defaults to site locale) and returns a string
     *
     * @param float  $number       unformatted number value, ex: 1234.56789
     * @param string $currency_ISO ex: "USD"
     * @param int    $format       one of the CurrencyFormatter::FORMAT_* constants
     * @return string              formatted value, ex: '1,234.57'
     */
    public function formatForCurrencyISO(
        float $number,
        string $currency_ISO,
        int $format = CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY
    ): string {
        $locale = $this->getLocaleForCurrencyISO($currency_ISO);
        return $this->format($locale, $number, $format);
    }


    /**
     * formats the provided number for the selected locale (defaults to site locale) and returns a string
     *
     * @param float|int|string   $number unformatted number value, ex: 1234.56789
     * @param int|null           $format one of the CurrencyFormatter::FORMAT_* constants
     * @param int|null           $precision the number of decimal places to round to
     * @param string|Locale|null $locale ex: "en_US" or Locale object
     * @return string            formatted value, ex: '1,234.57'
     */
    public function formatForLocale(
        $number,
        ?int $format = CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY,
        ?int $precision = null,
        $locale = ''
    ): string {
        $locale = $this->getLocale($locale);
        return $this->format($locale, (float) $number, $format, $precision);
    }


    /**
     * @param string|Locale $locale locale name ex: en_US or Locale object
     * @return string ex: 'USD'
     */
    public function getCurrencyIsoCodeForLocale($locale = ''): string
    {
        $locale = $this->getLocale($locale);
        return $locale->currencyIsoCode();
    }


    /**
     * @param string|Locale $locale locale name ex: en_US or Locale object
     * @return string ex: '$'
     */
    public function getCurrencySymbolForLocale($locale = ''): string
    {
        $locale = $this->getLocale($locale);
        return $locale->currencySymbol();
    }


    /**
     * Schemas:
     *    'precision_float': "1,234.567890"
     *    'localized_float': "1,234.57"
     *    'no_currency_code': "$1,234.57"
     *    null: "$1,234.57<span>USD</span>"
     *
     * @param string $schema
     * @param bool   $allow_fractional_subunits
     * @return int
     */
    public function getFormatFromLegacySchema(string $schema, bool $allow_fractional_subunits = true): int
    {
        switch ($schema) {
            case 'precision_float';
                // return a localized float if fractional subunits are not allowed
                return $allow_fractional_subunits
                    ? CurrencyFormatter::FORMAT_PRECISION_FLOAT
                    : CurrencyFormatter::FORMAT_LOCALIZED_FLOAT;
            case 'localized_float';
                return CurrencyFormatter::FORMAT_LOCALIZED_FLOAT;
            case 'localized';
            case 'localized_currency';
            case 'no_currency_code';
                return CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY;
            default;
                return CurrencyFormatter::FORMAT_LOCALIZED_CURRENCY_HTML_CODE;
        }
    }


    /**
     * @param string|Locale $locale locale name ex: en_US or Locale object
     * @return Locale
     */
    public function getLocale($locale = ''): Locale
    {
        $locale = $locale ?: $this->currency_config->locale();
        return $this->locales->getLocale($locale);
    }


    /**
     * @param string $currency_ISO              ex: USD
     * @param bool   $fallback_to_site_locale   [optional] if true, will return the site locale
     *                                          if a locale can not be identified for the supplied currency ISO
     * @return Locale
     */
    public function getLocaleForCurrencyISO(string $currency_ISO, bool $fallback_to_site_locale = false): Locale
    {
        return $this->locales->getLocaleForCurrencyISO($currency_ISO, $fallback_to_site_locale);
    }


    /**
     * @return Locale
     */
    public function getSiteLocale(): Locale
    {
        return $this->locales->getSiteLocale();
    }


    /**
     * This removes all localized formatting from the incoming value and returns a float
     *
     * @param float|int|string $number formatted numeric value as string, ex: '1,234,567.89'
     * @param string|Locale    $locale locale name ex: en_US or Locale object
     * @return float                   unformatted number value, ex: 1234567.89
     */
    public function parseForLocale($number, $locale = ''): float
    {
        // just return the value if it's not a string
        if (! is_string($number)) {
            return (float) $number;
        }
        $locale = $this->getLocale($locale);
        return $this->filterNumericValue(
            str_replace(
                [
                    $locale->currencyIsoCode(),
                    $locale->currencySymbol(),
                    $locale->currencyThousandsSeparator(),
                    $locale->currencyDecimalPoint(),
                ],
                [
                    '',  // remove currency code
                    '',  // remove currency symbol
                    '',  // remove thousands separator
                    '.', // convert decimal mark to what PHP expects
                ],
                $number
            )
        );
    }
}
